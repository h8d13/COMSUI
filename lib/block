#!/bin/bash

# Colors are already sourced by main script, no need to import again
# Block utility - run commands with colored output
block() {

    local color_func="info"
    local quiet=false
    local die_on_fail=false

    case "$1" in
        --info) color_func="info"; shift ;;
        --warn) color_func="warn"; shift ;;
        --gitop) color_func="gitop"; shift ;;
        --quiet) quiet=true; shift ;;
        --die) color_func="warn"; die_on_fail=true; shift ;;
    esac

    # Show command being executed (unless quiet)
    if [[ "$quiet" != "true" ]]; then
        $color_func "$* ..."
    fi

    # Record start time (milliseconds)
    local start_time=$(date +%s%3N)

    # Execute command and return exit code
    eval "$*"
    local exit_code=$?

    # Calculate execution time
    local end_time=$(date +%s%3N)
    local duration_ms=$((end_time - start_time))
    local duration=$(printf "%d.%03d" $((duration_ms / 1000)) $((duration_ms % 1000)))

    # Show result (unless quiet)
    if [[ "$quiet" != "true" ]]; then
        if [[ $exit_code -eq 0 ]]; then
            $color_func "Done in ${duration}s"
        else
            warn "Failed in ${duration}s"
        fi
    fi

    # Exit if die_on_fail is set and command failed
    if [[ "$die_on_fail" == "true" && $exit_code -ne 0 ]]; then
        die "Command failed - exiting"
    fi

    return $exit_code
}