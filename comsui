#!/bin/bash


comsui() {
  # Check for options
  extended_desc=""
  custom_desc=""

  while [[ $# -gt 0 ]]; do
    case $1 in
      -c)
        extended_desc=true
        shift
        ;;
      -d)
        custom_desc="$2"
        shift 2
        ;;
      *)
        echo "Unknown option: $1"
        echo "Usage: comsui [-c] [-d \"custom description\"]"
        return 1
        ;;
    esac
  done

  # ID + Date + Count
  randid=$(head /dev/urandom | tr -dc A-Z0-9 | head -c 6)
  today=$(date "+%m-%d")
  count_file="/tmp/commit_count_$today"
  if [ ! -f "$count_file" ]; then
    echo "0" > "$count_file"
    chmod 644 "$count_file"
  fi
  count=$(cat "$count_file" 2>/dev/null || echo "1")
  # Ensure count is a number
  count=$(($count + 0))

  # Capture changes BEFORE git add if extended description needed
  if [[ "$extended_desc" == "true" ]]; then
    files_changed=$(git status --porcelain | wc -l)
    shortstat=$(git diff HEAD --shortstat 2>/dev/null || echo "Initial commit")
  fi

  msg="$randid $(date "+%H:%M") #$(printf "%03d" $count)"

  # Add custom description if provided
  if [[ -n "$custom_desc" ]]; then
    msg="$msg

$custom_desc"
  fi

  # If -c option, add extended description
  if [[ "$extended_desc" == "true" ]]; then
    extended_body="

Extended commit details:
- Files changed: $files_changed
- Lines added/removed: $shortstat
- Branch: $(git branch --show-current)
- Timestamp: $(date)"
    msg="$msg$extended_body"
  fi

  echo "Commit suicide message: \"$msg\""
  read -p "Add, Commit and Push to origin/master? [y/N] " confirm
  git add .

  if [[ "$confirm" =~ ^[Yy]$ ]]; then
    if git commit -m "$msg" && git push origin master; then
      # Increment count and write back to file
      count=$((count + 1))
      echo "$count" > "$count_file"
      echo "Count incremented to $count"
    else
      echo "Git operations failed, count not incremented."
    fi
  else
    echo "Aborted."
  fi
}
