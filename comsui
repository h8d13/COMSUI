#!/bin/bash
# App configuration
APP=${APP:-comsui}

# Source colors from appropriate locations
if [ -f "$(dirname "$0")/${APP}-lib/colors" ]; then
    source "$(dirname "$0")/${APP}-lib/colors"
    source "$(dirname "$0")/${APP}-lib/sync"
else
    source "$(dirname "$0")/lib/colors"
    source "$(dirname "$0")/lib/sync"
fi

comsui() {
  # Check for options
  extended_desc=""
  custom_desc=""

  while [[ $# -gt 0 ]]; do
    case $1 in
      -l)
        extended_desc=true
        shift
        ;;
      -c)
        custom_desc="$2"
        shift 2
        ;;
      *)
        die "Unknown option: $1
Usage: comsui [-l] [-c \"custom description\"]"
        ;;
    esac
  done

  # Check if we're in a git repository
  if ! git rev-parse --git-dir >/dev/null 2>&1; then
    die "Error: Not in a git repository"
  fi

  # ID + Date + Count per repository
  randid=$(head /dev/urandom | tr -dc A-Z0-9 | head -c 6)
  today=$(date "+%m-%d")
  repo_name=$(basename "$(git rev-parse --show-toplevel)")
  count_file="/tmp/comsui_${repo_name}_$today"

  if [ ! -f "$count_file" ]; then
    echo "0" > "$count_file"
  fi
  count=$(cat "$count_file" 2>/dev/null || echo "0")
  # Ensure count is a number
  count=$(($count + 0))

  # Capture useful info if extended description needed
  if [[ "$extended_desc" == "true" ]]; then
    last_commit=$(git log -1 --format="%h - %s" 2>/dev/null || echo "No previous commits")
    last_commit_time=$(git log -1 --format="%cr" 2>/dev/null || echo "unknown")
  fi

  msg="$randid $(date "+%H:%M") #$(printf "%03d" $count)"

  # Add custom description if provided
  if [[ -n "$custom_desc" ]]; then
    msg="$msg

$custom_desc"
  fi

  # If -l option, add extended description
  if [[ "$extended_desc" == "true" ]]; then
    extended_body="

Last commit: $last_commit ($last_commit_time)"
    msg="$msg$extended_body"
  fi

  gitop "git add ."
  git add .
  read -p "Commit and push to origin/master? [y/N] " confirm
  if [[ "$confirm" =~ ^[Yy]$ ]]; then
    gitop "git commit -m \"$msg\""
    if git commit -m "$msg"; then
      gitop "git push origin master"
      if git push origin master; then
        # Increment count and write back to file
        count=$((count + 1))
        echo "$count" > "$count_file"
        info "Count incremented to $count"
      else
        die "Git push failed, count not incremented."
      fi
    else
      die "Git commit failed, count not incremented."
    fi
  else
    info "Aborted."
  fi
}

comsui "$@"
