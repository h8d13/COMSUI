#!/bin/bash
# App configuration
APP=${APP:-comsui}

# Source colors from appropriate locations
if [ -f "$(dirname "$0")/${APP}-lib/colors" ]; then
    source "$(dirname "$0")/${APP}-lib/colors"
    source "$(dirname "$0")/${APP}-lib/sync"
else
    source "$(dirname "$0")/lib/colors"
    source "$(dirname "$0")/lib/sync"
fi

comsui() {
  # Check for options
  extended_desc=""
  custom_desc=""

  while [[ $# -gt 0 ]]; do
    case $1 in
      -l)
        extended_desc=true
        shift
        ;;
      -c)
        custom_desc="$2"
        shift 2
        ;;
      *)
        echo -e "${RED}Unknown option: $1${NC}"
        echo -e "${RED}Usage: comsui [-l] [-c \"custom description\"]${NC}"
        return 1
        ;;
    esac
  done

  # Check if we're in a git repository
  if ! git rev-parse --git-dir >/dev/null 2>&1; then
    echo -e "${RED}Error: Not in a git repository${NC}"
    return 1
  fi

  # ID + Date + Count per repository
  randid=$(head /dev/urandom | tr -dc A-Z0-9 | head -c 6)
  today=$(date "+%m-%d")
  repo_name=$(basename "$(git rev-parse --show-toplevel)")
  count_file="/tmp/comsui_${repo_name}_$today"

  if [ ! -f "$count_file" ]; then
    echo "0" > "$count_file"
  fi
  count=$(cat "$count_file" 2>/dev/null || echo "0")
  # Ensure count is a number
  count=$(($count + 0))

  # Capture useful info if extended description needed
  if [[ "$extended_desc" == "true" ]]; then
    last_commit=$(git log -1 --format="%h - %s" 2>/dev/null || echo "No previous commits")
    last_commit_time=$(git log -1 --format="%cr" 2>/dev/null || echo "unknown")
    # Check if last commit is signed
    validation=""
    if [[ -n "$(git log -1 --format="%H" 2>/dev/null)" ]]; then
      if git log -1 --format="%G?" | grep -q "G"; then
        validation="✓ signed"
      elif git log -1 --format="%G?" | grep -q "B"; then
        validation="✗ bad signature"
      else
        validation="○ unsigned"
      fi
    fi
  fi

  msg="$randid $(date "+%H:%M") #$(printf "%03d" $count)"

  # Add custom description if provided
  if [[ -n "$custom_desc" ]]; then
    msg="$msg

$custom_desc"
  fi

  # If -l option, add extended description
  if [[ "$extended_desc" == "true" ]]; then
    extended_body="

Last commit: $last_commit ($last_commit_time)"
    if [[ -n "$validation" ]]; then
      extended_body="$extended_body
Validation: $validation"
    fi
    msg="$msg$extended_body"
  fi

  echo -e "${GREEN}git add .${NC}"
  git add .
  read -p "Commit and push to origin/master? [y/N] " confirm
  if [[ "$confirm" =~ ^[Yy]$ ]]; then
    echo -e "${GREEN}git commit -m \"$msg\"${NC}"
    if git commit -m "$msg"; then
      echo -e "${GREEN}git push origin master${NC}"
      if git push origin master; then
        # Increment count and write back to file
        count=$((count + 1))
        echo "$count" > "$count_file"
        echo -e "${BLUE}Count incremented to $count${NC}"
      else
        echo -e "${RED}Git push failed, count not incremented.${NC}"
      fi
    else
      echo -e "${RED}Git commit failed, count not incremented.${NC}"
    fi
  else
    echo -e "${BLUE}Aborted.${NC}"
  fi
}

comsui "$@"
